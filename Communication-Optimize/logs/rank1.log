/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/cuda/__init__.py:61: FutureWarning: The pynvml package is deprecated. Please install nvidia-ml-py instead. If you did not install pynvml directly, please report this to the maintainers of the package that installed pynvml for you.
  import pynvml  # type: ignore[import]
2026-01-08 21:47:32,667 - init - INFO - 检测到单机多卡环境，使用NCCL后端
2026-01-08 21:47:32,899 - Rank-1 - INFO - 初始化设备 Rank 1/3
2026-01-08 21:47:33,076 - Rank-1 - INFO - 加载模型: /data/home/chenyu/Coding/SD+SoT/models/Qwen3-4B
2026-01-08 21:47:33,076 - Rank-1 - INFO - 注意：所有设备都加载完整模型，Prefill阶段选择对应层计算
`torch_dtype` is deprecated! Use `dtype` instead!
[Rank 1] 单机多卡模式(无环境隔离)，使用GPU 1
Loading checkpoint shards:   0%|          | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███▎      | 1/3 [00:00<00:01,  1.22it/s]Loading checkpoint shards:  67%|██████▋   | 2/3 [00:01<00:00,  1.82it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:01<00:00,  2.52it/s]
2026-01-08 21:47:34,304 - Rank-1 - INFO - 模型加载完成，共36层
2026-01-08 21:47:34,304 - Rank-1 - INFO - 模型加载完成，共36层
2026-01-08 21:47:34,304 - Rank-1 - INFO - ============================================================
2026-01-08 21:47:34,304 - Rank-1 - INFO - 开始 Prefill 阶段 (SP+PP)
2026-01-08 21:47:34,314 - Rank-1 - INFO - Prompt长度: 26 tokens
2026-01-08 21:47:34,314 - Rank-1 - INFO - 切分为 1 个chunks (chunk_size=128)
2026-01-08 21:47:34,314 - Rank-1 - INFO - 负责层范围: [12, 24)
2026-01-08 21:47:34,315 - Rank-1 - INFO - 处理 chunk 1/1
2026-01-08 21:47:34,398 - Rank-1 - ERROR - 推理过程出错: NCCL error in: /pytorch/torch/csrc/distributed/c10d/NCCLUtils.hpp:268, unhandled system error (run with NCCL_DEBUG=INFO for details), NCCL version 2.21.5
ncclSystemError: System call (e.g. socket, malloc) or external library call failed or device error. 
Last error:
socketStartConnect: Connect to 10.30.2.11<42931> failed : Software caused connection abort
Traceback (most recent call last):
  File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 383, in run_inference
    last_hidden, kv_caches = self.prefill_phase(prompt)
  File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 212, in prefill_phase
    hidden_states = self._receive_hidden_states()
  File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 340, in _receive_hidden_states
    dist.recv(shape, src=self.rank - 1)
  File "/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/distributed/c10d_logger.py", line 81, in wrapper
    return func(*args, **kwargs)
  File "/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/distributed/distributed_c10d.py", line 2482, in recv
    work = irecv(tensor, src=src, group=group, tag=tag, group_src=group_src)
  File "/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/distributed/distributed_c10d.py", line 2420, in irecv
    return group.recv([tensor], group_src, tag)
torch.distributed.DistBackendError: NCCL error in: /pytorch/torch/csrc/distributed/c10d/NCCLUtils.hpp:268, unhandled system error (run with NCCL_DEBUG=INFO for details), NCCL version 2.21.5
ncclSystemError: System call (e.g. socket, malloc) or external library call failed or device error. 
Last error:
socketStartConnect: Connect to 10.30.2.11<42931> failed : Software caused connection abort
[rank1]: Traceback (most recent call last):
[rank1]:   File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 446, in <module>
[rank1]:     main()
[rank1]:   File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 442, in main
[rank1]:     engine.run_inference(args.prompt, args.max_new_tokens)
[rank1]:   File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 383, in run_inference
[rank1]:     last_hidden, kv_caches = self.prefill_phase(prompt)
[rank1]:   File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 212, in prefill_phase
[rank1]:     hidden_states = self._receive_hidden_states()
[rank1]:   File "/data/home/chenyu/Coding/SD+SoT/Communication-Optimize/distributed_inference.py", line 340, in _receive_hidden_states
[rank1]:     dist.recv(shape, src=self.rank - 1)
[rank1]:   File "/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/distributed/c10d_logger.py", line 81, in wrapper
[rank1]:     return func(*args, **kwargs)
[rank1]:   File "/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/distributed/distributed_c10d.py", line 2482, in recv
[rank1]:     work = irecv(tensor, src=src, group=group, tag=tag, group_src=group_src)
[rank1]:   File "/data/home/chenyu/anaconda3/envs/sdsot/lib/python3.9/site-packages/torch/distributed/distributed_c10d.py", line 2420, in irecv
[rank1]:     return group.recv([tensor], group_src, tag)
[rank1]: torch.distributed.DistBackendError: NCCL error in: /pytorch/torch/csrc/distributed/c10d/NCCLUtils.hpp:268, unhandled system error (run with NCCL_DEBUG=INFO for details), NCCL version 2.21.5
[rank1]: ncclSystemError: System call (e.g. socket, malloc) or external library call failed or device error. 
[rank1]: Last error:
[rank1]: socketStartConnect: Connect to 10.30.2.11<42931> failed : Software caused connection abort
